name: ğŸš€ Lab 3 - Docker CI/CD

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [ docker-lab3 ]
    paths:
      - 'Dockerfile'
      - 'app/**'
      - 'requirements.txt'
      - '.github/workflows/docker-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "ğŸ”§ Lab 3 - Docker Deployment"
        echo "Trigger: ${{ github.event_name }}"
        echo "CI pushes to GHCR, CD pulls from registry"
        echo "Branch: ${{ github.ref }}"
        echo "Actor: ${{ github.actor }}"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ñ€Ñ‚ 2435 Ğ¸Ğ· Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
        port: 2435
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ username masha Ğ¸Ğ· Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
        username: masha
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Lab 3: Docker Deployment ==="
          echo "Pulling image from GitHub Container Registry..."
          
          # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
          # Ğ”Ğ»Ñ Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ :latest, Ğ´Ğ»Ñ Ğ²ĞµÑ‚Ğ¾Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¸Ğ¼Ñ Ğ²ĞµÑ‚ĞºĞ¸
          if [[ "${{ github.event_name }}" == "release" ]]; then
            IMAGE_TAG="latest"
            IMAGE_NAME="ghcr.io/fursovamashaa/catty-reminders-app:$IMAGE_TAG"
          else
            IMAGE_TAG="docker-lab3"
            IMAGE_NAME="ghcr.io/${{ github.repository }}:$IMAGE_TAG"
          fi
          
          echo "Pulling image: $IMAGE_NAME"
          docker pull $IMAGE_NAME
          
          echo "Stopping old container..."
          docker stop catty-reminders 2>/dev/null || true
          docker rm catty-reminders 2>/dev/null || true
          
          echo "Starting new container..."
          docker run -d \
            --name catty-reminders \
            --restart unless-stopped \
            -p 8181:8181 \
            $IMAGE_NAME
          
          sleep 5
          echo "âœ… Docker container deployed successfully!"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
          echo "ğŸ“Š Container status:"
          docker ps --filter "name=catty-reminders" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "ğŸŒ Application URL: http://app.titovskih.course.prafdin.ru"
          echo "ğŸ“¦ Image used: $IMAGE_NAME"
          echo "ğŸ¯ Trigger: ${{ github.event_name }}"
