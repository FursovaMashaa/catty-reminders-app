name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/vm_key
          chmod 600 ~/.ssh/vm_key
          ssh-keyscan -p 2435 course.prafdin.ru >> ~/.ssh/known_hosts

      - name: Deploy Docker Container to VM
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository }}
        run: |
          IMAGE_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]'):latest

          echo "üöÄ Deploying $IMAGE_LOWER to VM..."

          ssh -o BatchMode=yes \
              -i ~/.ssh/vm_key \
              -p 2435 \
              masha@course.prafdin.ru "
              
            # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –≤ GHCR —Å GITHUB_TOKEN
            echo '${{ secrets.GITHUB_TOKEN }}' | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            sudo docker pull $IMAGE_LOWER
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            sudo docker stop catty-container 2>/dev/null || true
            sudo docker rm catty-container 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            sudo docker run -d \
              --name catty-container \
              -p 8181:8181 \
              --restart always \
              $IMAGE_LOWER
              
            # –ü—Ä–æ–≤–µ—Ä–∫–∞
            echo '‚úÖ Deployment finished!'
            sudo docker ps --filter name=catty-container --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'
          "
