name: CD - Deploy Application

on:
  release:
    types: [published]
  workflow_dispatch:  # Ğ”Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2435 course.prafdin.ru >> ~/.ssh/known_hosts
    
    - name: Deploy to server via SSH
      run: |
        echo "ğŸš€ Deploying application via SSH port 2475..."
        ssh -p 2435 masha@course.prafdin.ru << 'ENDSSH'
          cd /home/masha/catty-app
          echo "Current directory: \$(pwd)"
          echo "Pulling latest changes..."
          git pull origin github-actions
          echo "Installing dependencies..."
          pip3 install -r requirements.txt --break-system-packages
          echo "Stopping previous application..."
          pkill -f uvicorn || true
          echo "Starting new application..."
          nohup /home/masha/.local/bin/uvicorn app.main:app --host 0.0.0.0 --port 8181 > app.log 2>&1 &
          echo "âœ… Deployment completed!"
        ENDSSH
    
    - name: Verify deployment
      run: |
        echo "ğŸš€ Application deployed successfully!"
        echo "ğŸ“… Deployment time: $(date)"
        echo "ğŸŒ Application URL: http://app.fursova.course.prafdin.ru"
        echo "ğŸ”§ SSH port used: 2435"
