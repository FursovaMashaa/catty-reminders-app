name: CD - Deploy Application

on:
  release:
    types: [published]
  workflow_dispatch:  # Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° (ÑƒÐ´Ð¾Ð±Ð½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install and verify dependencies (build stage)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -c "import app.main; print('âœ… App import successful')"

      - name: Run unit tests (optional but recommended)
        run: python -m pytest tests/test_unit.py -v

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 2435 course.prafdin.ru >> ~/.ssh/known_hosts

      - name: Deploy to VM via SSH
        run: |
          ssh -p 2435 masha@course.prafdin.ru << 'ENDSSH'
            set -e  # Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ

            cd /home/masha/catty-app

            echo "ðŸ” Pulling latest code from github-actions..."
            git reset --hard
            git clean -fd
            git pull origin github-actions

            echo "ðŸ Setting up virtual environment..."
            python3 -m venv venv
            ./venv/bin/pip install --upgrade pip
            ./venv/bin/pip install -r requirements.txt
            ./venv/bin/playwright install --with-deps chromium

            echo "ðŸ›‘ Stopping old app (if any)..."
            pkill -f "uvicorn.*8181" || true

            echo "ðŸš€ Starting new app on port 8181..."
            nohup ./venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8181 > app.log 2>&1 &

            sleep 2
            echo "âœ… Deployment completed!"
          ENDSSH

      - name: Final notification
        run: |
          echo "âœ… Application deployed successfully!"
          echo "ðŸ”— URL: http://app.fursova.course.prafdin.ru"
          echo "ðŸ•’ Deployed at: $(date -u)"
