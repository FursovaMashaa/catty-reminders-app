name: üöÄ Lab 3 - Docker Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [ lab3-docker ]
    paths:
      - 'Dockerfile'
      - 'app/**'
      - 'requirements.txt'
      - '.github/workflows/docker-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "üîß Lab 3 - Docker Deployment"
        echo "Trigger: ${{ github.event_name }}"
        echo "CI pushes to GHCR, CD pulls from registry"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        port: 2435
        username: nopressure
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Lab 3: Docker Deployment ==="
          echo "Pulling image from GitHub Container Registry..."
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # –¢—è–Ω–µ–º –æ–±—Ä–∞–∑
          docker pull ghcr.io/${{ github.repository }}:docker-lab3
          
          echo "Stopping old container..."
          docker stop catty-reminders || true
          docker rm catty-reminders || true
          
          echo "Starting new container..."
          docker run -d \
            --name catty-reminders \
            --restart unless-stopped \
            -p 8181:8181 \
            ghcr.io/${{ github.repository }}:docker-lab3
          
          sleep 5
          echo "‚úÖ Docker container deployed from registry!"
          echo "üì° Application: http://app.fursova.course.prafdin.ru"
          echo ""
          echo "üìä Architecture:"
          echo "- CI: builds and pushes to GHCR"
          echo "- CD: pulls from GHCR and deploys"
