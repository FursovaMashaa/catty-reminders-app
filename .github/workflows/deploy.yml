name: ðŸš€ Lab 3 - Docker Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [ lab3-docker ]
    paths:
      - 'Dockerfile'
      - 'app/**'
      - 'requirements.txt'
      - '.github/workflows/docker-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug info
      run: |
        echo "ðŸ”§ Lab 3 - Docker Deployment"
        echo "Trigger: ${{ github.event_name }}"
        echo "CI pushes to GHCR, CD pulls from registry"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        port: 2435
        username: masha
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
            echo "=== Lab 3: Docker Deployment ==="
            
            # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð¸Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð² Ð½Ð¸Ð¶Ð½Ð¸Ð¹ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€
            IMAGE_NAME="ghcr.io/fursovamashaa/catty-reminders-app:latest"
            
            echo "Pulling image from GitHub Container Registry..."
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
            docker pull $IMAGE_NAME
          
            echo "Stopping old container..."
            docker stop catty-reminders 2>/dev/null || true
            docker rm catty-reminders 2>/dev/null || true
          
            echo "Starting new container..."
            docker run -d \
              --name catty-reminders \
              --restart unless-stopped \
              -p 8181:8181 \
              $IMAGE_NAME
          
            sleep 5
            echo "âœ… Docker container deployed from registry!"
            echo "ðŸ“¡ Application: http://app.fursova.course.prafdin.ru"
