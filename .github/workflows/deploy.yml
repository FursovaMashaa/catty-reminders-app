name: CD - Deploy Docker Container

on:
  release:
    types: [published]
  workflow_dispatch:  # Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: course.prafdin.ru
          port: 2435
          username: masha
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Lab 3: Docker Deployment ==="
            
            # Ð›Ð¾Ð³Ð¸Ð½ Ð² GHCR
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Ð˜Ð¼Ñ Ð¾Ð±Ñ€Ð°Ð·Ð° â€” ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ðµ Ð±ÑƒÐºÐ²Ñ‹!
            IMAGE="ghcr.io/fursovamashaa/catty-reminders-app:latest"
            
            echo "Pulling image: $IMAGE"
            docker pull "$IMAGE"
            
            echo "Stopping old container (if exists)..."
            docker stop catty-reminders 2>/dev/null || true
            docker rm catty-reminders 2>/dev/null || true
            
            echo "Starting new container..."
            docker run -d \
              --name catty-reminders \
              --restart unless-stopped \
              -p 8181:8181 \
              "$IMAGE"
            
            sleep 3
            echo "âœ… Container deployed!"
            echo "ðŸ“¡ App URL: http://app.fursova.course.prafdin.ru"
